<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Nachito Waves - Jose Hidalgo</title>
<style>
/* ESTILOS GENERALES */
html, body { height: 100%; margin: 0; padding: 0; background-color: #121212; }
body {
    color: #0f0;
    font-family: 'Courier New', monospace;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 20px;
}
/* Contenedor Principal */
.container {
    width: 95%; max-width: 1100px;
    border: 1px solid #333; padding: 20px;
    background: #000;
    box-shadow: 0 0 20px rgba(0, 255, 0, 0.15);
    box-sizing: border-box;
    margin-bottom: 50px;
}
/* Título */
h2 {
    text-align: center; margin: 0 0 15px 0;
    text-transform: uppercase; letter-spacing: 3px;
    line-height: 1.2; color: #0f0;
    text-shadow: 0 0 8px rgba(0, 255, 0, 0.6);
}
.sub-title { font-size: 0.6em; display: block; margin-top: 5px; color: #00d2ff; }

/* CONTROLES SUPERIORES */
.controls {
    display: flex; gap: 15px; justify-content: center; align-items: center;
    margin-bottom: 15px; background: #1a1a1a; padding: 10px; border: 1px solid #333;
    flex-wrap: wrap;
}
button {
    background: #333; color: #fff; border: 1px solid #555;
    padding: 5px 15px; cursor: pointer; font-family: inherit;
    text-transform: uppercase; transition: 0.3s; min-width: 120px;
    font-weight: bold;
}
button:hover { background: #555; }
button.active { background: #d32f2f; border-color: #f44336; box-shadow: 0 0 10px #d32f2f; }
input[type="file"] { color: white; }
audio { height: 30px; outline: none; }

/* DASHBOARD */
.dashboard { display: flex; gap: 15px; align-items: stretch; }
.graphs-col { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; min-width: 0; }
canvas { background-color: #050505; width: 100%; border: 1px solid #333; display: block; }
#oscilloscope { height: 120px; border-bottom: none; }
#visualizer { height: 300px; }
.screen-label {
    font-size: 0.8em; color: #ffffff; margin-bottom: 5px;
    text-transform: uppercase; font-weight: bold; letter-spacing: 1px;
}

/* Panel de Datos */
.data-col { width: 220px; min-width: 220px; display: flex; flex-direction: column; gap: 8px; }
.data-box {
    background: #111; border: 1px solid #333; padding: 10px;
    text-align: center; display: flex; flex-direction: column;
    justify-content: center; box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
    flex-grow: 1; 
}
.data-title { font-size: 0.7em; color: #888; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; }
.data-val {font-size: 1.5em; font-weight: bold; color: #0f0; text-shadow: 0 0 5px rgba(0,255,0,0.3); }
.data-val.note { color: #00d2ff; }
.data-val.phys { color: #ff9800; }
.footer-info { font-size: 0.8em; color: #fff; text-align: center; margin-top: 5px; opacity: 0.9; }

/* GENERADOR DE TONOS */
.generator-panel {
    margin-top: 20px;
    border: 2px solid #00d2ff;
    background: #0a0a15;
    padding: 15px;
    display: flex;
    align-items: center;
    justify-content: space-around;
    gap: 10px;
    box-shadow: 0 0 15px rgba(0, 210, 255, 0.2);
    flex-wrap: wrap;
}
.gen-title {
    width: 100%; text-align: center; color: #00d2ff;
    font-weight: bold; margin-bottom: 10px; letter-spacing: 2px;
}
.gen-control { display: flex; flex-direction: column; align-items: center; gap: 5px; }
.gen-control label { font-size: 0.8em; color: #aaa; }
select { background: #222; color: #fff; border: 1px solid #444; padding: 5px; font-family: inherit; }
input[type=range] { cursor: pointer; }
button#btnTone {
    background: #004d40; border-color: #00695c; color: #00d2ff;
}
button#btnTone.active {
    background: #00d2ff; color: #000; box-shadow: 0 0 15px #00d2ff;
}
</style>
</head>
<body>
<div class="container">
    <h2>NACHITO WAVES <span class="sub-title">(Analizador de Sonido - Jose Hidalgo)</span></h2>
    
    <div class="controls">
        <input type="file" id="fileInput" accept="audio/*" />
        <audio id="audioPlayer" controls></audio>
        <button id="btnFreeze">⏸ Congelar</button>
    </div>

    <div class="dashboard">
        <div class="graphs-col">
            <div>
                <div class="screen-label">Osciloscopio (Dominio del Tiempo)</div>
                <canvas id="oscilloscope" width="800" height="120"></canvas>
            </div>
            <div>
                <div class="screen-label">Espectro FFT (Dominio de Frecuencia)</div>
                <canvas id="visualizer" width="800" height="300"></canvas>
            </div>
        </div>
        
        <div class="data-col">
            <div class="data-box">
                <div class="data-title">Frecuencia Pico (f)</div>
                <div class="data-val" id="peakFreq">-- Hz</div>
            </div>
            <div class="data-box">
                <div class="data-title">Nota Musical</div>
                <div class="data-val note" id="noteVal">--</div>
            </div>
            <div class="data-box">
                <div class="data-title">Periodo (T)</div>
                <div class="data-val phys" id="periodVal">-- ms</div>
            </div>
            <div class="data-box">
                <div class="data-title">Longitud Onda (λ)</div>
                <div class="data-val phys" id="lambdaVal">-- m</div>
            </div>
            <div class="footer-info">
                Muestreo: <span id="sampleRateDisplay">--</span> Hz<br>
                (vSonido = 343 m/s)
            </div>
        </div>
    </div>

    <div class="generator-panel">
        <div class="gen-title">⚡ GENERADOR DE FUNCIONES (MODO DOCENTE) ⚡</div>
        <div class="gen-control">
            <label>Forma de Onda</label>
            <select id="waveType">
                <option value="sine">Senoidal (Pura)</option>
                <option value="square">Cuadrada (Armónicos Impares)</option>
                <option value="sawtooth">Diente de Sierra (Todos)</option>
                <option value="triangle">Triangular (Suave)</option>
            </select>
        </div>
        <div class="gen-control">
            <label>Frecuencia: <span id="freqLabel" style="color:#00d2ff">440</span> Hz</label>
            <input type="range" id="freqSlider" min="50" max="1000" step="1" value="440" style="width: 200px;">
        </div>
        <div class="gen-control">
            <label>Volumen (A)</label>
            <input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.5">
        </div>
        <div class="gen-control">
            <button id="btnTone">ACTIVAR TONO</button>
        </div>
    </div>
</div>

<script>
// --- REFERENCIAS ---
const fileInput = document.getElementById('fileInput');
const audioPlayer = document.getElementById('audioPlayer');
const btnFreeze = document.getElementById('btnFreeze');
const btnTone = document.getElementById('btnTone');
const waveType = document.getElementById('waveType');
const freqSlider = document.getElementById('freqSlider');
const volSlider = document.getElementById('volSlider');
const freqLabel = document.getElementById('freqLabel');

const canvasSpec = document.getElementById('visualizer');
const canvasOsc = document.getElementById('oscilloscope');
const ctxSpec = canvasSpec.getContext('2d');
const ctxOsc = canvasOsc.getContext('2d');

const displayFreq = document.getElementById('peakFreq');
const displayNote = document.getElementById('noteVal');
const displayRate = document.getElementById('sampleRateDisplay');
const displayPeriod = document.getElementById('periodVal');
const displayLambda = document.getElementById('lambdaVal');

// --- VARIABLES ---
let audioContext;
let analyser;
let source;
let osc;
let gainNode;
let isInitialized = false;
let isFrozen = false;
let isTonePlaying = false;

const notes = ["Do", "Do#", "Re", "Re#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"];

// --- INICIALIZACIÓN ---
function initAudioContext() {
    if(isInitialized) return;
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 4096; 
    analyser.smoothingTimeConstant = 0.85;

    gainNode = audioContext.createGain();
    gainNode.gain.value = volSlider.value;
    gainNode.connect(analyser);
    analyser.connect(audioContext.destination);

    source = audioContext.createMediaElementSource(audioPlayer);
    source.connect(analyser);
    
    displayRate.innerText = audioContext.sampleRate;
    isInitialized = true;
    loop();
}

// --- GENERADOR ---
btnTone.addEventListener('click', () => {
    if(!isInitialized) initAudioContext();
    if(audioContext.state === 'suspended') audioContext.resume();

    if(isTonePlaying) {
        if(osc) { osc.stop(); osc.disconnect(); }
        isTonePlaying = false;
        btnTone.innerText = "ACTIVAR TONO";
        btnTone.classList.remove('active');
    } else {
        osc = audioContext.createOscillator();
        osc.type = waveType.value;
        osc.frequency.value = freqSlider.value;
        osc.connect(gainNode);
        osc.start();
        isTonePlaying = true;
        btnTone.innerText = "APAGAR TONO";
        btnTone.classList.add('active');
        
        if(isFrozen) {
            isFrozen = false;
            btnFreeze.classList.remove('active');
            btnFreeze.innerText = "⏸ CONGELAR";
            loop();
        }
    }
});

freqSlider.addEventListener('input', (e) => {
    freqLabel.innerText = e.target.value;
    if(osc && isTonePlaying) {
        osc.frequency.value = e.target.value;
    }
});

volSlider.addEventListener('input', (e) => {
    if(gainNode) gainNode.gain.value = e.target.value;
});

waveType.addEventListener('change', (e) => {
    if(osc && isTonePlaying) osc.type = e.target.value;
});

// --- ARCHIVO ---
fileInput.addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
        audioPlayer.src = URL.createObjectURL(file);
        isFrozen = false;
        btnFreeze.classList.remove('active');
        btnFreeze.innerText = "⏸ CONGELAR";
    }
});

audioPlayer.addEventListener('play', function() {
    if (!isInitialized) initAudioContext();
    if (audioContext.state === 'suspended') audioContext.resume();
    if(isFrozen) {
        isFrozen = false;
        btnFreeze.classList.remove('active');
        btnFreeze.innerText = "⏸ CONGELAR";
        loop();
    }
});

audioPlayer.addEventListener('seeked', function() {
    if(isInitialized && analyser) {
        setTimeout(() => drawFrame(), 50);
    }
});

// --- CONGELAR ---
btnFreeze.addEventListener('click', () => {
    if (!isInitialized) return;
    if (isFrozen) {
        isFrozen = false;
        if(!audioPlayer.paused) audioPlayer.play();
        btnFreeze.classList.remove('active');
        btnFreeze.innerText = "⏸ CONGELAR";
        loop();
    } else {
        isFrozen = true;
        if(!audioPlayer.paused) audioPlayer.pause();
        btnFreeze.classList.add('active');
        btnFreeze.innerText = "▶ REANUDAR";
    }
});

function getNote(frequency) {
    if(frequency < 20) return "--";
    const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
    const noteIndex = (Math.round(noteNum) + 69) % 12;
    const octave = Math.floor((Math.round(noteNum) + 69) / 12) - 1;
    return notes[noteIndex] + octave;
}

// --- DIBUJO ---
function loop() {
    if(isFrozen) return;
    requestAnimationFrame(loop);
    drawFrame();
}

function drawFrame() {
    if (!analyser) return;

    const bufferLength = analyser.frequencyBinCount;
    const dataFreq = new Uint8Array(bufferLength);
    const dataTime = new Uint8Array(bufferLength);

    analyser.getByteFrequencyData(dataFreq);
    analyser.getByteTimeDomainData(dataTime);

    // Osciloscopio
    ctxOsc.fillStyle = '#000';
    ctxOsc.fillRect(0, 0, canvasOsc.width, canvasOsc.height);
    ctxOsc.lineWidth = 2;
    ctxOsc.strokeStyle = '#0f0';
    ctxOsc.beginPath();

    const sliceWidth = canvasOsc.width / bufferLength;
    let x = 0;
    for(let i = 0; i < bufferLength; i++) {
        const v = dataTime[i] / 128.0;
        const y = v * (canvasOsc.height / 2);
        if(i === 0) ctxOsc.moveTo(x, y); else ctxOsc.lineTo(x, y);
        x += sliceWidth;
    }
    ctxOsc.stroke();
    ctxOsc.strokeStyle = '#222'; 
    ctxOsc.beginPath(); ctxOsc.moveTo(0, canvasOsc.height/2); ctxOsc.lineTo(canvasOsc.width, canvasOsc.height/2); ctxOsc.stroke();

    // Espectro
    ctxSpec.fillStyle = '#000';
    ctxSpec.fillRect(0, 0, canvasSpec.width, canvasSpec.height);

    const barWidth = canvasSpec.width / bufferLength;
    let xBar = 0;
    let maxVal = 0;
    let maxIndex = 0;

    for(let i = 0; i < bufferLength; i++) {
        const val = dataFreq[i];
        const percent = val / 255;
        const height = percent * canvasSpec.height;
        const y = canvasSpec.height - height;
        
        if (val > maxVal) { maxVal = val; maxIndex = i; }

        ctxSpec.fillStyle = `hsl(${i/bufferLength * 360}, 100%, 50%)`;
        ctxSpec.fillRect(xBar, y, barWidth + 1, height);
        xBar += barWidth;
    }

    drawGrid(ctxSpec, canvasSpec.width, canvasSpec.height);
    updateDataPanel(maxVal, maxIndex, bufferLength);
}

function updateDataPanel(maxVal, maxIndex, bufferLength) {
    const nyquist = audioContext.sampleRate / 2;
    const freq = maxIndex * (nyquist / bufferLength);

    if (maxVal > 5) {
        displayFreq.innerText = Math.round(freq) + " Hz";
        displayNote.innerText = getNote(freq);
        
        if(freq > 0) {
            displayPeriod.innerText = (1000/freq).toFixed(2) + " ms";
            let lam = 343 / freq;
            displayLambda.innerText = (lam < 1) ? (lam*100).toFixed(1) + " cm" : lam.toFixed(2) + " m";
        }
    }
}

function drawGrid(ctx, w, h) {
    ctx.strokeStyle = '#333'; ctx.fillStyle = '#888'; ctx.lineWidth = 1; ctx.font = '10px monospace';
    
    for(let i=1; i<5; i++){
        let y = h - (h*(i/5));
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
    }
    
    const maxFreq = audioContext.sampleRate / 2;
    const steps = [100, 500, 1000, 5000, 10000, 20000];
    
    steps.forEach(f => {
        if(f < maxFreq) {
            let x = (f / maxFreq) * w;
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
            ctx.fillText(f < 1000 ? f : (f/1000)+"k", x+2, h-5);
        }
    });
}
</script>
</body>
</html>