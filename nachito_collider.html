<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nachito Collider - FX Edition</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        
        h1 { color: #2c3e50; margin-bottom: 5px; font-size: 2.5em; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }
        p.subtitle { color: #7f8c8d; margin-top: 0; margin-bottom: 25px; font-size: 1.1em; font-weight: 500; }
        
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 95%; max-width: 1100px; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr auto; gap: 20px; margin-bottom: 20px; background: #e9ecef; padding: 15px; border-radius: 8px; align-items: center; }
        
        .cart-panel { border: 1px solid #ccc; padding: 10px; border-radius: 5px; background: #fff; }
        .cart-title { font-weight: bold; margin-bottom: 10px; display: block; text-align: center; }
        .red-title { color: #e74c3c; }
        .blue-title { color: #3498db; }

        .control-group { display: flex; justify-content: space-between; margin-bottom: 5px; align-items: center; }
        .control-group label { font-size: 0.9em; font-weight: bold; color: #555; }
        .control-group input { width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        
        .vehicle-label { font-size: 0.8em; color: #555; text-align: center; margin: 5px 0; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; background: #eee; padding: 2px; border-radius: 3px;}
        .unit-hint { font-size: 0.8em; color: #888; text-align: right; margin-top: 0px; font-style: italic; }

        .global-settings { display: flex; flex-direction: column; gap: 10px; justify-content: center; }

        canvas { background-color: #fff; border: 2px solid #333; border-radius: 4px; display: block; margin: 0 auto; }
        
        #graphCanvas { background-color: #111; border: 2px solid #555; margin-top: 10px; }

        .buttons { margin-top: 20px; text-align: center; display: flex; justify-content: center; gap: 10px; }
        button { padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 1em; color: white; }
        
        .btn-lanzar { background-color: #28a745; } .btn-lanzar:hover { background-color: #218838; }
        .btn-stop { background-color: #dc3545; } .btn-stop:hover { background-color: #c82333; }
        .btn-reset { background-color: #ffc107; color: #333; } .btn-reset:hover { background-color: #e0a800; }
        .btn-exportar { background-color: #007bff; } .btn-exportar:hover { background-color: #0069d9; }
        .btn-exportar:disabled { background-color: #ccc; cursor: not-allowed; }

        .data-table { width: 100%; margin-top: 15px; border-collapse: collapse; font-size: 0.9em; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .data-table th { background-color: #f2f2f2; }
        .highlight { font-weight: bold; color: #2c3e50; }
        
        .change-val { font-family: 'Consolas', monospace; font-size: 0.95em; }
        .arrow { color: #aaa; margin: 0 5px; }
        .final-val { font-weight: bold; color: #000; }
    </style>
</head>
<body>

    <h1>Nachito Collider</h1>
    <p class="subtitle">Laboratorio de Choques - Jose Hidalgo</p>
    
    <div class="container">
        <div class="controls">
            <div class="cart-panel" style="border-left: 5px solid #e74c3c;">
                <span class="cart-title red-title">VEH√çCULO 1 (Izquierda)</span>
                <div class="control-group">
                    <label>Masa (kg)</label>
                    <input type="number" id="m1" value="170" step="10" min="1" onchange="previsualizar()">
                </div>
                <div id="type1" class="vehicle-label">Motocicleta</div>
                <div class="control-group">
                    <label>Rapidez (km/h)</label>
                    <input type="number" id="v1" value="72.0" step="1" min="0" onchange="previsualizar()">
                </div>
                <div id="v1_ms" class="unit-hint">20.00 m/s</div>
            </div>

            <div class="cart-panel" style="border-left: 5px solid #3498db;">
                <span class="cart-title blue-title">VEH√çCULO 2 (Derecha)</span>
                <div class="control-group">
                    <label>Masa (kg)</label>
                    <input type="number" id="m2" value="170" step="10" min="1" onchange="previsualizar()">
                </div>
                <div id="type2" class="vehicle-label">Motocicleta</div>
                <div class="control-group">
                    <label>Rapidez (km/h)</label>
                    <input type="number" id="v2" value="72.0" step="1" min="0" onchange="previsualizar()">
                </div>
                <div id="v2_ms" class="unit-hint">20.00 m/s</div>
            </div>

            <div class="global-settings">
                <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                    <label>Elasticidad (e)</label>
                    <select id="restitucion" style="width: 100%; padding: 5px; margin-top: 5px;" onchange="previsualizar()">
                        <option value="1">1.0 (El√°stico Ideal)</option>
                        <option value="0.8">0.8 (Realista - Acero)</option>
                        <option value="0.5">0.5 (Inel√°stico)</option>
                        <option value="0" selected>0.0 (Pl√°stico - Choque)</option>
                    </select>
                </div>
            </div>
        </div>

        <canvas id="simCanvas" width="1000" height="250"></canvas>
        <canvas id="graphCanvas" width="1000" height="150"></canvas>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Propiedad (Inicial <span class="arrow">&rarr;</span> Actual)</th>
                    <th style="color:#e74c3c">Veh√≠culo 1</th>
                    <th style="color:#3498db">Veh√≠culo 2</th>
                    <th>TOTAL (Sistema)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Velocidad [m/s]</td>
                    <td id="vel1" class="change-val">--</td>
                    <td id="vel2" class="change-val">--</td>
                    <td id="velTotal" class="change-val">--</td>
                </tr>
                <tr>
                    <td>Momento (P) [kg¬∑m/s]</td>
                    <td id="p1" class="change-val">--</td>
                    <td id="p2" class="change-val">--</td>
                    <td id="pTotal" class="change-val highlight">--</td>
                </tr>
                <tr>
                    <td>Energ√≠a Cin√©tica (K) [J]</td>
                    <td id="k1" class="change-val">--</td>
                    <td id="k2" class="change-val">--</td>
                    <td id="kTotal" class="change-val highlight">--</td>
                </tr>
            </tbody>
        </table>

        <div class="buttons">
            <button class="btn-reset" onclick="resetTotal()">‚èÆ RESET</button>
            <button class="btn-lanzar" id="btnToggle" onclick="toggleSimulacion()">‚ñ∂ INICIAR</button>
            <button class="btn-exportar" id="btnExportar" onclick="exportarExcel()" disabled>üìä DESCARGAR REPORTE (.xls)</button>
        </div>
    </div>

<script>
    const cvs = document.getElementById('simCanvas');
    const ctx = cvs.getContext('2d');
    const graphCvs = document.getElementById('graphCanvas');
    const gCtx = graphCvs.getContext('2d');

    let animId;
    let corriendo = false;
    let tiempo = 0;

    let c1 = { x: 150, w: 80, h: 40, m: 1500, v: 20, color: '#e74c3c', type: 'auto' };
    let c2 = { x: 750, w: 80, h: 40, m: 1500, v: -20, color: '#3498db', type: 'auto' };
    let e = 0; 

    let iniState = { v1: 0, v2: 0, p1: 0, p2: 0, pTot: 0, k1: 0, k2: 0, kTot: 0 };
    let historialV1 = [];
    let historialV2 = [];
    let datosCSV = [];

    // Variables para efectos visuales
    let explosionFrame = 0; 
    let explosionX = 0;
    let audioCtx = null;

    const pxPorMetro = 5; 
    const groundY = 200;

    resetTotal();

    // --- SONIDO DE CHOQUE ---
    function playCrashSound() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const t = audioCtx.currentTime;
        
        // Ruido blanco (Impacto)
        const bufferSize = audioCtx.sampleRate * 0.5; // 0.5 segundos
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;

        // Filtro paso bajo para darle "cuerpo" al golpe
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(1000, t);
        filter.frequency.exponentialRampToValueAtTime(100, t + 0.3);

        // Envolvente de volumen (Golpe seco)
        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(1, t);
        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);

        noise.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);
        noise.start();
    }

    function toggleSimulacion() {
        const btn = document.getElementById('btnToggle');
        const btnExp = document.getElementById('btnExportar');

        if (corriendo) {
            corriendo = false;
            cancelAnimationFrame(animId);
            btn.innerText = "‚ñ∂ CONTINUAR";
            btn.className = "btn-lanzar"; 
            btnExp.disabled = false; 
        } else {
            // Iniciar contexto de audio con interacci√≥n de usuario
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            if (tiempo === 0) {
                historialV1 = [];
                historialV2 = [];
                datosCSV = [];
                leerInputs(); 
                
                iniState.v1 = c1.v;
                iniState.v2 = c2.v;
                iniState.p1 = c1.m * c1.v;
                iniState.p2 = c2.m * c2.v;
                iniState.pTot = iniState.p1 + iniState.p2;
                iniState.k1 = 0.5 * c1.m * c1.v * c1.v;
                iniState.k2 = 0.5 * c2.m * c2.v * c2.v;
                iniState.kTot = iniState.k1 + iniState.k2;

                datosCSV.push([
                    "Tiempo (s)", 
                    "Pos1 (m)", "Vel1 (m/s)", "Momento1 (kg.m/s)", "Kinetica1 (J)",
                    "Pos2 (m)", "Vel2 (m/s)", "Momento2 (kg.m/s)", "Kinetica2 (J)",
                    "Momento Total", "Energia Total"
                ]);
                
                explosionFrame = 0; // Resetear explosi√≥n
            }
            corriendo = true;
            btn.innerText = "‚è∏ DETENER";
            btn.className = "btn-stop"; 
            btnExp.disabled = true; 
            loop();
        }
    }

    function resetTotal() {
        cancelAnimationFrame(animId);
        corriendo = false;
        tiempo = 0;
        explosionFrame = 0;
        
        const btn = document.getElementById('btnToggle');
        btn.innerText = "‚ñ∂ INICIAR";
        btn.className = "btn-lanzar";
        document.getElementById('btnExportar').disabled = true;

        document.getElementById('m1').value = "170"; 
        document.getElementById('v1').value = "72.0";
        document.getElementById('m2').value = "170";
        document.getElementById('v2').value = "72.0"; 
        document.getElementById('restitucion').value = "0"; 
        
        limpiarTabla();
        c1.x = 150; c2.x = 750;
        leerInputs(); dibujar(); dibujarGrafico();
    }

    function previsualizar() {
        if(corriendo) return; 
        leerInputs();
        c1.x = 150; c2.x = 750;
        limpiarTabla();
        dibujar();
    }
    
    function limpiarTabla() {
        const arrow = "<span class='arrow'>&rarr;</span>";
        const zero = "<span class='final-val'>0.00</span>";
        document.getElementById('vel1').innerHTML = `0.00 ${arrow} ${zero}`;
        document.getElementById('vel2').innerHTML = `0.00 ${arrow} ${zero}`;
        document.getElementById('velTotal').innerHTML = `-`;
        document.getElementById('p1').innerHTML = `0 ${arrow} ${zero}`;
        document.getElementById('p2').innerHTML = `0 ${arrow} ${zero}`;
        document.getElementById('pTotal').innerHTML = `0 ${arrow} ${zero}`;
        document.getElementById('k1').innerHTML = `0 ${arrow} ${zero}`;
        document.getElementById('k2').innerHTML = `0 ${arrow} ${zero}`;
        document.getElementById('kTotal').innerHTML = `0 ${arrow} ${zero}`;
    }

    function determinarVehiculo(masa) {
        if (masa < 120) return { type: 'bici', w: 40, h: 30, label: 'Bicicleta' };
        if (masa >= 120 && masa < 500) return { type: 'moto', w: 50, h: 30, label: 'Motocicleta' };
        if (masa >= 500 && masa < 2000) return { type: 'auto', w: 90, h: 40, label: 'Autom√≥vil' };
        if (masa >= 2000 && masa < 4000) return { type: 'pickup', w: 110, h: 50, label: 'Camioneta' };
        if (masa >= 4000 && masa < 12000) return { type: 'bus', w: 180, h: 70, label: '√ìmnibus' };
        return { type: 'semi', w: 250, h: 70, label: 'Cami√≥n c/Acoplado' };
    }

    function leerInputs() {
        c1.m = parseFloat(document.getElementById('m1').value);
        let props1 = determinarVehiculo(c1.m);
        c1.w = props1.w; c1.h = props1.h; c1.type = props1.type;
        document.getElementById('type1').innerText = props1.label;
        let v1_kmh = Math.abs(parseFloat(document.getElementById('v1').value));
        c1.v = v1_kmh / 3.6;
        document.getElementById('v1_ms').innerText = c1.v.toFixed(2) + " m/s";

        c2.m = parseFloat(document.getElementById('m2').value);
        let props2 = determinarVehiculo(c2.m);
        c2.w = props2.w; c2.h = props2.h; c2.type = props2.type;
        document.getElementById('type2').innerText = props2.label;
        let v2_kmh = Math.abs(parseFloat(document.getElementById('v2').value));
        c2.v = -(v2_kmh / 3.6);
        document.getElementById('v2_ms').innerText = Math.abs(c2.v).toFixed(2) + " m/s";
        
        e = parseFloat(document.getElementById('restitucion').value);
    }

    function loop() {
        if(!corriendo) return;
        let dt = 1/60; tiempo += dt;

        c1.x += c1.v * pxPorMetro * dt;
        c2.x += c2.v * pxPorMetro * dt;

        // Detecci√≥n de colisi√≥n con solapamiento
        if (c1.x + c1.w >= c2.x) { 
            // Solo ejecutar si a√∫n no hemos explotado visualmente (primer frame del choque)
            if (explosionFrame === 0) {
                playCrashSound();
                explosionX = c1.x + c1.w; // Punto de impacto
                explosionFrame = 1; // Iniciar animaci√≥n
            }
            resolverColision(); 
        }

        if (historialV1.length < 1000) { historialV1.push(c1.v); historialV2.push(c2.v); }

        let p1 = c1.m * c1.v; let k1 = 0.5 * c1.m * c1.v * c1.v; let pos1_m = c1.x / pxPorMetro; 
        let p2 = c2.m * c2.v; let k2 = 0.5 * c2.m * c2.v * c2.v; let pos2_m = c2.x / pxPorMetro;
        let pTot = p1 + p2; let kTot = k1 + k2;

        datosCSV.push([tiempo.toFixed(3), pos1_m.toFixed(2), c1.v.toFixed(2), p1.toFixed(2), k1.toFixed(2), pos2_m.toFixed(2), c2.v.toFixed(2), p2.toFixed(2), k2.toFixed(2), pTot.toFixed(2), kTot.toFixed(2)]);

        dibujar(); dibujarGrafico(); actualizarTabla(p1, p2, pTot, k1, k2, kTot);

        if (c1.x < -400 || c1.x > cvs.width + 400 || c2.x < -400 || c2.x > cvs.width + 400) {
            toggleSimulacion();
        } else {
            animId = requestAnimationFrame(loop);
        }
    }

    function resolverColision() {
        let v1i = c1.v; let v2i = c2.v; let m1 = c1.m; let m2 = c2.m;
        let v1f = (m1*v1i + m2*v2i + m2*e*(v2i - v1i)) / (m1 + m2);
        let v2f = (m1*v1i + m2*v2i + m1*e*(v1i - v2i)) / (m1 + m2);
        c1.v = v1f; c2.v = v2f;
        let overlap = (c1.x + c1.w) - c2.x;
        if (overlap > 0) { c1.x -= overlap/2; c2.x += overlap/2; }
    }

    function actualizarTabla(p1, p2, pTot, k1, k2, kTot) {
        const fmt = (val) => Math.abs(val).toFixed(0); 
        const fmtV = (val) => Math.abs(val).toFixed(2);
        const arrow = "<span class='arrow'>&rarr;</span>";

        document.getElementById('vel1').innerHTML = `${fmtV(iniState.v1)} ${arrow} <span class='final-val'>${fmtV(c1.v)}</span>`;
        document.getElementById('vel2').innerHTML = `${fmtV(iniState.v2)} ${arrow} <span class='final-val'>${fmtV(c2.v)}</span>`;
        
        document.getElementById('p1').innerHTML = `${fmt(iniState.p1)} ${arrow} <span class='final-val'>${fmt(p1)}</span>`;
        document.getElementById('p2').innerHTML = `${fmt(iniState.p2)} ${arrow} <span class='final-val'>${fmt(p2)}</span>`;
        document.getElementById('pTotal').innerHTML = `${fmt(iniState.pTot)} ${arrow} <span class='final-val'>${fmt(pTot)}</span>`;

        document.getElementById('k1').innerHTML = `${fmt(iniState.k1)} ${arrow} <span class='final-val'>${fmt(k1)}</span>`;
        document.getElementById('k2').innerHTML = `${fmt(iniState.k2)} ${arrow} <span class='final-val'>${fmt(k2)}</span>`;
        document.getElementById('kTotal').innerHTML = `${fmt(iniState.kTot)} ${arrow} <span class='final-val'>${fmt(kTot)}</span>`;
    }

    function dibujar() {
        ctx.clearRect(0,0, cvs.width, cvs.height);
        let grad = ctx.createLinearGradient(0, 0, 0, groundY);
        grad.addColorStop(0, "#B3E5FC"); grad.addColorStop(1, "#E1F5FE");
        ctx.fillStyle = grad; ctx.fillRect(0, 0, cvs.width, groundY);
        ctx.fillStyle = '#546E7A'; ctx.fillRect(0, groundY, cvs.width, cvs.height - groundY);
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 3; ctx.setLineDash([20, 20]);
        ctx.beginPath(); ctx.moveTo(0, groundY + 25); ctx.lineTo(cvs.width, groundY + 25); ctx.stroke(); ctx.setLineDash([]);
        
        drawVehicle(c1, 1);  
        drawVehicle(c2, -1); 

        // --- EFECTO DE EXPLOSI√ìN ---
        if (explosionFrame > 0 && explosionFrame < 20) {
            drawExplosion(explosionX, groundY - 30, explosionFrame);
            explosionFrame++;
        }
    }

    function drawExplosion(x, y, frame) {
        let size = frame * 3;
        let alpha = 1 - (frame / 20);
        
        ctx.save();
        ctx.translate(x, y);
        
        // Estrella amarilla/naranja
        ctx.fillStyle = `rgba(255, 165, 0, ${alpha})`;
        ctx.beginPath();
        for (let i = 0; i < 8; i++) {
            ctx.rotate(Math.PI / 4);
            ctx.lineTo(0, 0);
            ctx.lineTo(10 + size, 0);
            ctx.lineTo(5, 5);
        }
        ctx.fill();

        // Centro blanco flash
        if (frame < 5) {
            ctx.fillStyle = 'white';
            ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI*2); ctx.fill();
        }

        ctx.restore();
    }

    function drawVehicle(c, dir) {
        let wheelR = (c.type === 'semi' || c.type === 'bus') ? 12 : (c.type === 'bici' ? 14 : (c.type === 'moto' ? 10 : 9));
        let bottomY = groundY - wheelR; 
        ctx.save();
        if (c.type === 'bici') {
            ctx.strokeStyle = c.color; ctx.lineWidth = 3;
            let rearX = dir === 1 ? c.x + 10 : c.x + c.w - 10; let frontX = dir === 1 ? c.x + c.w - 10 : c.x + 10;
            let pedalX = dir === 1 ? c.x + 30 : c.x + c.w - 30; let seatX = dir === 1 ? c.x + 20 : c.x + c.w - 20; let handleX = dir === 1 ? c.x + c.w - 20 : c.x + 20; 
            ctx.beginPath(); ctx.arc(rearX, bottomY, 14, 0, Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.arc(frontX, bottomY, 14, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(rearX, bottomY); ctx.lineTo(seatX, bottomY-20); ctx.lineTo(pedalX, bottomY); ctx.lineTo(rearX, bottomY); 
            ctx.moveTo(seatX, bottomY-20); ctx.lineTo(handleX, bottomY-20); ctx.lineTo(frontX, bottomY); ctx.stroke();
            ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(seatX, bottomY-35, 5, 0, Math.PI*2); ctx.fill();
        } else if (c.type === 'moto') {
            ctx.fillStyle = c.color;
            let rearX = dir === 1 ? c.x + 10 : c.x + c.w - 10; let frontX = dir === 1 ? c.x + c.w - 5 : c.x + 5; 
            let seatX = dir === 1 ? c.x + 10 : c.x + c.w - 10; let handleBaseX = dir === 1 ? c.x + c.w - 15 : c.x + 15;
            ctx.beginPath(); ctx.moveTo(rearX, bottomY - 15); ctx.lineTo(seatX, bottomY - 25); ctx.lineTo(handleBaseX, bottomY - 25); 
            ctx.lineTo(frontX, bottomY - 10); ctx.lineTo(dir === 1 ? c.x + 5 : c.x + c.w - 5, bottomY - 10); ctx.fill();
            ctx.fillStyle = '#212121'; let wheelRearX = dir === 1 ? c.x + 10 : c.x + c.w - 10; let wheelFrontX = dir === 1 ? c.x + c.w - 10 : c.x + 10;
            ctx.beginPath(); ctx.arc(wheelRearX, bottomY, 10, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(wheelFrontX, bottomY, 10, 0, Math.PI*2); ctx.fill();
        } else if (c.type === 'auto') {
            ctx.fillStyle = c.color; ctx.fillRect(c.x, bottomY - 15, c.w, 15);
            ctx.beginPath(); let cabinaStart = dir === 1 ? c.x + 10 : c.x + c.w - 10; let cabinaEnd = dir === 1 ? c.x + c.w - 25 : c.x + 25;
            ctx.moveTo(cabinaStart, bottomY - 15); ctx.lineTo(dir === 1 ? c.x + 25 : c.x + c.w - 25, bottomY - 35); ctx.lineTo(dir === 1 ? c.x + c.w - 35 : c.x + 35, bottomY - 35); ctx.lineTo(cabinaEnd, bottomY - 15); ctx.fill();
            ctx.fillStyle = '#212121'; ctx.beginPath(); ctx.arc(c.x+15, bottomY, 9, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(c.x+c.w-15, bottomY, 9, 0, Math.PI*2); ctx.fill();
        } else if (c.type === 'pickup') {
            ctx.fillStyle = c.color; ctx.fillRect(c.x, bottomY - 20, c.w, 20);
            let bedW = 40; let cabX = dir === 1 ? c.x : c.x + bedW; ctx.fillRect(cabX, bottomY - 45, c.w - bedW, 25);
            ctx.fillStyle = '#212121'; ctx.beginPath(); ctx.arc(c.x+20, bottomY, 11, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(c.x+c.w-20, bottomY, 11, 0, Math.PI*2); ctx.fill();
        } else if (c.type === 'bus') {
            ctx.fillStyle = c.color; ctx.fillRect(c.x, bottomY - 60, c.w, 60);
            ctx.fillStyle = '#b3e5fc'; for(let i=10; i<c.w-10; i+=30) { ctx.fillRect(c.x+i, bottomY-50, 20, 15); }
            ctx.fillStyle = '#212121'; ctx.beginPath(); ctx.arc(c.x+30, bottomY, 12, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(c.x+c.w-30, bottomY, 12, 0, Math.PI*2); ctx.fill();
        } else if (c.type === 'semi') {
            let cabW = 60; let trailerW = c.w - cabW - 10; let cabX = dir === 1 ? c.x + trailerW + 10 : c.x; let trailX = dir === 1 ? c.x : c.x + cabW + 10;
            ctx.fillStyle = c.color; ctx.fillRect(cabX, bottomY - 50, cabW, 50); ctx.fillStyle = '#eeeeee'; ctx.fillRect(trailX, bottomY - 60, trailerW, 60);
            ctx.strokeStyle = '#999'; ctx.lineWidth = 1; ctx.strokeRect(trailX, bottomY - 60, trailerW, 60);
            ctx.fillStyle = '#212121'; ctx.beginPath(); ctx.arc(cabX + 15, bottomY, 12, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(cabX + cabW - 15, bottomY, 12, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(trailX + 15, bottomY, 12, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(trailX + 40, bottomY, 12, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(trailX + trailerW - 15, bottomY, 12, 0, Math.PI*2); ctx.fill();
        }
        if (Math.abs(c.v) > 0.1) {
            ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.beginPath();
            let arrowY = bottomY - c.h - 30; let arrowX = c.x + c.w/2; let length = c.v * 3; 
            ctx.moveTo(arrowX, arrowY); ctx.lineTo(arrowX + length, arrowY); ctx.stroke();
            ctx.beginPath(); ctx.fillStyle = '#000';
            if (c.v > 0) { ctx.moveTo(arrowX + length, arrowY - 4); ctx.lineTo(arrowX + length + 8, arrowY); ctx.lineTo(arrowX + length, arrowY + 4); } 
            else { ctx.moveTo(arrowX + length, arrowY - 4); ctx.lineTo(arrowX + length - 8, arrowY); ctx.lineTo(arrowX + length, arrowY + 4); }
            ctx.fill();
            ctx.textAlign = 'center'; ctx.font = 'bold 12px Arial';
            let kmh = (Math.abs(c.v) * 3.6).toFixed(1); ctx.fillText(kmh + " km/h", arrowX, arrowY - 8);
        }
        ctx.restore();
    }

    function dibujarGrafico() {
        let w = graphCvs.width; let h = graphCvs.height; gCtx.clearRect(0, 0, w, h);
        gCtx.strokeStyle = '#555'; gCtx.lineWidth = 1; let zeroY = h / 2;
        gCtx.beginPath(); gCtx.moveTo(0, zeroY); gCtx.lineTo(w, zeroY); gCtx.stroke();
        gCtx.fillStyle = '#aaa'; gCtx.fillText("0 m/s", 5, zeroY - 5);
        drawGraphLine(historialV1, '#e74c3c'); drawGraphLine(historialV2, '#3498db');
    }

    function drawGraphLine(data, color) {
        if(data.length < 2) return;
        let w = graphCvs.width; let h = graphCvs.height; let zeroY = h / 2; let stepX = w / 300; 
        gCtx.strokeStyle = color; gCtx.lineWidth = 2; gCtx.beginPath();
        for(let i=0; i<data.length; i++) {
            let x = i * stepX; let y = zeroY - (data[i] * 2); 
            if (i===0) gCtx.moveTo(x, y); else gCtx.lineTo(x, y);
        }
        gCtx.stroke();
    }

    function exportarExcel() {
        let nombreArchivo = "Nachito_Collider_Reporte.xls";
        
        let tablaHTML = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head>
                <meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">
                <style>
                    table { border-collapse: collapse; font-family: Arial; }
                    th { background-color: #4472C4; color: white; font-weight: bold; border: 1px solid #000; padding: 8px; }
                    td { text-align: center; border: 0.5px solid #ccc; padding: 5px; }
                    .resumen-header { background-color: #ffc107; color: #000; font-weight: bold; border: 1px solid #000; }
                    .resumen-valor { background-color: #fff3cd; font-weight: bold; border: 1px solid #000; }
                </style>
            </head>
            <body>
                <table>
                    <thead>
                        <tr>
                            <th>Tiempo (s)</th><th>Pos1 (m)</th><th>Vel1 (m/s)</th><th>P1 (kg¬∑m/s)</th><th>K1 (J)</th>
                            <th>Pos2 (m)</th><th>Vel2 (m/s)</th><th>P2 (kg¬∑m/s)</th><th>K2 (J)</th>
                            <th>P Total</th><th>K Total</th>
                            <th style="border:none; background:none;"></th>
                            <th class="resumen-header">RESUMEN</th><th class="resumen-header">VALOR</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        let m1Str = c1.m.toFixed(0) + " kg";
        let v1Str = (iniState.v1 * 3.6).toFixed(1) + " km/h";
        let m2Str = c2.m.toFixed(0) + " kg";
        let v2Str = (Math.abs(iniState.v2) * 3.6).toFixed(1) + " km/h";
        let eStr = e.toFixed(2);

        for (let i = 0; i < datosCSV.length; i++) {
            if (i === 0) continue; 
            let fila = datosCSV[i];
            let filaHTML = "<tr>";
            for(let j=0; j < fila.length; j++) { filaHTML += `<td>${String(fila[j]).replace('.', ',')}</td>`; }
            filaHTML += `<td style="border:none;"></td>`;

            if (i === 1) { filaHTML += `<td class="resumen-header">Masa V1</td><td class="resumen-valor">${m1Str}</td>`; }
            else if (i === 2) { filaHTML += `<td class="resumen-header">Vel Inicial V1</td><td class="resumen-valor">${v1Str}</td>`; }
            else if (i === 3) { filaHTML += `<td class="resumen-header">Masa V2</td><td class="resumen-valor">${m2Str}</td>`; }
            else if (i === 4) { filaHTML += `<td class="resumen-header">Vel Inicial V2</td><td class="resumen-valor">${v2Str}</td>`; }
            else if (i === 5) { filaHTML += `<td class="resumen-header">Elasticidad (e)</td><td class="resumen-valor">${eStr}</td>`; }
            else { filaHTML += `<td style="border:none;"></td><td style="border:none;"></td>`; }

            filaHTML += "</tr>";
            tablaHTML += filaHTML;
        }
        tablaHTML += `</tbody></table></body></html>`;

        var blob = new Blob([tablaHTML], { type: 'application/vnd.ms-excel' });
        var link = document.createElement("a");
        var url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", nombreArchivo);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>